# 本人非 IT 专业人员

==============================================================================

# 安装
apt update
apt install dnsmasq -y

# 配置开机启动服务
systemctl enable dnsmasq --now

# 检查服务状态
sudo systemctl status dnsmasq

# 配置服务内容，conf 文件
------------------------------------------------
vim /etc/dnsmasq.conf

# ====================== 基础网络适配（旁路由核心）======================
# 1. 监听地址：本地回环+旁路由IP（确保局域网设备可访问）
# 旁路由IP为你之前配置的 192.168.0.6，必须包含，否则其他设备无法用此DNS
listen-address=127.0.0.1,192.168.0.6
# 2. 绑定接口（仅在ens18上提供服务，避免冲突）
interface=ens18
# 3. 禁用DHCP（旁路由不承担DHCP功能，由爱快主路由负责）
no-dhcp-interface=ens18
# 4. 端口固定为53（参考库约定Dnsmasq占用默认DNS端口）
port=53


# ====================== DNS链条转发（适配mosdns+AdGuard Home）======================
# 1. 核心：将DNS请求转发到AdGuard Home（端口54，后续由AGH过滤广告后转发给mosdns）
# 参考库逻辑：Dnsmasq作为“入口DNS”，优先走AGH广告过滤，再到mosdns优化解析
server=127.0.0.1#54
# 2. 备用上游：若AGH故障，直接转发到mosdns（端口55），避免DNS中断
server=127.0.0.1#55
# 临时用公共 DNS（等装完 mosdns/AGH 再改回转发到 54/55）
#server=223.5.5.5  # 阿里云 DNS
#server=119.29.29.29  # 腾讯云 DNS
# 3. 禁止读取系统默认resolv.conf（避免干扰自定义DNS链条）
no-resolv
# 4. 禁止转发“无域名后缀”的请求（减少无效查询，参考库推荐优化）
domain-needed
# 5. 禁止转发“私有网段域名”（避免公网DNS污染，参考库安全配置）
bogus-priv

# -----------------------------------------------------------------------------
# Dnsmasq 缓存优化配置 (Cache Optimization Configuration)
# -----------------------------------------------------------------------------

# 1. 设置一个合理的缓存大小
# 根据你的设备内存调整。对于路由器，10000到50000通常足够。
# 300000适用于内存非常大的设备。
cache-size=300000

# 2. 启用并配置否定缓存
# 缓存不存在的域名记录，避免重复向上游查询无效域名。设置为1小时。
# 请确保删除了 `no-negcache` 这一行。
neg-ttl=3600

# 4. 设置合理的最小和最大缓存时间 (TTL)
# 强制所有记录最少缓存1小时 (3600秒)，即使上游服务器建议的TTL很短。
# 这可以有效抵抗某些域名使用超低TTL（如60秒）来绕过缓存的行为。
min-cache-ttl=3600

# 强制所有记录最多缓存1天 (86400秒)。
# 防止因上游服务器设置过长的TTL（如一周）导致记录更新不及时。
max-cache-ttl=86400

# 6. 查询策略 (个人选择)
# 严格按照上游DNS服务器顺序查询。
strict-order

# ====================== 安全与兼容（参考库避坑配置）======================
# 1. 忽略Windows无效请求（避免触发爱快主路由拨号，参考库优化）
filterwin2k
# 2. 拒绝“wpad”域名请求（修复安全漏洞，参考库安全提示）
dhcp-name-match=set:wpad-ignore,wpad
dhcp-ignore-names=tag:wpad-ignore
# 3. 不读取/etc/hosts（避免本地记录干扰DNS链条，参考库约定）
no-hosts


------------------------------------------------

# 重启服务
systemctl restart dnsmasq

# 检查服务状态
sudo systemctl status dnsmasq

# 配置完成，旁路由通了。
==============================================================================
